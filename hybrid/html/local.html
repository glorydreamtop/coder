 <!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta content="telephone=no" name="format-detection" />
		<meta content="email=no" name="format-detection" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="./juejin.css" rel="stylesheet" type="text/css" />
		<link href="./article.css" rel="stylesheet" type="text/css" />
		<title>文章详情</title>
	</head>
	<body>
		<div id="article_app" class="article-content">
		</div>
		<div id="coder_mask" class="coder_hidden" onclick="maskHidden()">
		</div>
		<div id="coder_popup" class="coder_hidden">
			<div class="coder_title">
				收藏夹
			</div>
			<div class="coder_list" id="coder_list">

			</div>
		</div>
		<!-- <div id="coder_comments">
			<div class="">
				<div class="coder_comments_main">
					<div class="coder_comments_user">
						<img src="head.png" >
						<div class="coder_comments_userInfo">
							<span>略略略呵呵哈哈</span>
							<span>签约作者他爸爸的儿子</span>
						</div>
					</div>
					<div class="coder_comments_detail">
						<div class="">
							时代峰峻思范文覅我服你Woi而烦恼问烦恼我额覅嗡嗡狗儿干哈人得用非叫我番茄锅不够ear办呢欧日部分
						</div>
						<div class="">
							
						</div>
					</div>
				</div>
				<div class="coder_comments_answer">
					
				</div>
			</div>
			<div class="">
				
			</div>
		</div> -->
	</body>
	<script type="text/javascript" src="https://js.cdn.aliyun.dcloud.net.cn/dev/uni-app/uni.webview.1.5.2.js"></script>
	<script type="text/javascript">
		//隐藏弹窗和遮罩
		const maskHidden = () => {
			document.getElementById('coder_mask').className = 'coder_hidden';
			document.getElementById('coder_popup').className = 'coder_hidden';
			return;
		}
		//打开弹窗和遮罩
		const collection = (list) => {
			const innerHTMLs = [];
			list.forEach(item => {
				const innerHTML =
					`<div class="coder_list_item">
						<img src="${item.img}">
						<span>${item.title}</span>
						<div>${item.entryCount}</div>
						<img class="select" src="${item.isIn?'select_cur.png':'select.png'}" data-csId="${item.csId}" onclick="collect('${item.csId}&${item.isIn}')">
					</div>`
				innerHTMLs.push(innerHTML)
			})
			document.getElementById('coder_list').innerHTML = innerHTMLs.join('');
			document.getElementById('coder_popup').className = 'coder_show';
			document.getElementById('coder_mask').className = 'coder_show';
			//fixedBody();
			return;
		}

		const cleanArray = (actual) => {
			const newArray = []
			for (let i = 0; i < actual.length; i++) {
				if (actual[i]) {
					newArray.push(actual[i])
				}
			}
			return newArray
		}
		// object转querystring
		const param = (json) => {
			if (!json) return ''
			return cleanArray(
				Object.keys(json).map(key => {
					if (json[key] === undefined) return ''
					return encodeURIComponent(key) + '=' + encodeURIComponent(json[key])
				})
			).join('&')
		}
		// querystring转object
		const getQueryObject = (params) => {
			const obj = {}
			const reg = /([^?&=]+)=([^?&=]*)/g
			params.replace(reg, (rs, $1, $2) => {
				const name = decodeURIComponent($1)
				let val = decodeURIComponent($2)
				val = String(val)
				obj[name] = val
				return rs
			})
			return obj
		}
		// 收藏
		const collect = (querys) => {
			// 得到参数csId和是否本文在此收藏夹中
			const [csId,isIn] = querys.split('&');
			// 准备请求参数
			const data = {
				csId,
				entryId: getQueryObject(params).id,
				src: 'web',
				userId: getQueryObject(params).uid,
				clientId: getQueryObject(params).device_id,
				token: getQueryObject(params).token
			};
			// 转化为querystring
			const query = param(data);
			// 根据当前状态决定增删
			const type = isIn === 'true' ? 'delEntry' : 'addEntry';
			const xhr = new XMLHttpRequest();
			xhr.onreadystatechange = () => {
				if (xhr.readyState === 4 && xhr.status === 200 && JSON.parse(xhr.responseText).m === 'success') {
					document.querySelector(`[data-csId='${csId}']`).src = type === 'addEntry' ? 'select_cur.png' : 'select.png';
					setTimeout(maskHidden(),500);
					plus.nativeUI.toast(type === 'addEntry' ? '收藏成功' : '取消成功');
				}
			}
			xhr.open('PUT', `https://collection-set-ms.juejin.im/v1/${type}?${query}`);
			xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
			xhr.send();
		}
		const params = window.location.search.substring(1);
		// 获取文章详情
		const getDetail = () => {
			const detailUrl = 'https://post-storage-api-ms.juejin.im/v1/getDetailData';
			document.addEventListener('plusready', function() {
				const xhr = new plus.net.XMLHttpRequest();
				xhr.open("GET", `${detailUrl}?${params}`);
				xhr.send();
				xhr.onload = () => {
					document.getElementById('article_app').innerHTML = JSON.parse(xhr.responseText).d.content;
				}
			}, false);
		}
		const commentsList = [];
		const getComments = () => {
			const data = {
				createdAt:'',
				rankType:'new',
				pageSize:6
			}
			const id = getQueryObject(params).id
			const commentsUrl = 'https://comment-wrapper-ms.juejin.im/v1/comments/entry/';
			const xhr = new plus.net.XMLHttpRequest();
			xhr.open("GET",`${commentsUrl}${id}?${param(data)}`);
			xhr.send();
			xhr.onload = () => {
				commentsList = JSON.parse(xhr.responseText).d.comments;
				
			}
		}
		getDetail();
	</script>
</html>
